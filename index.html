<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiivinen Liiketoimintasuunnitelma-Agentti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: Sovellus on suunniteltu yksisivuiseksi, tehtäväorientoituneeksi työkaluksi. Rakenne perustuu kaksipalstaiseen asetteluun: vasemmalla on kiinteä navigointipalkki, joka toimii prosessin vaiheistuksena, ja oikealla on dynaaminen sisältöalue. Käyttäjä voi klikata vasemmanpuoleisesta valikosta haluamaansa vaihetta (esim. "Liikeidea"), jolloin kyseisen vaiheen kysymykset ja selitykset ilmestyvät oikealle. Tämä rakenne valittiin, koska se pilkkoo monivaiheisen prosessin helposti omaksuttaviin osiin ja antaa käyttäjälle selkeän kuvan kokonaisuudesta sekä vapauden tutkia osioita haluamassaan järjestyksessä. Se on staattista dokumenttia interaktiivisempi ja käyttäjäystävällisempi tapa hahmottaa agentin toimintalogiikka. -->
    <!-- Visualization & Content Choices: Sovellus visualisoi agentin luomisprosessin ilman data-visualointeja, koska lähdemateriaali on ohjeistus. Vaiheet (Organize) -> Interaktiivinen pystysuuntainen navigointivalikko (HTML/CSS/JS) -> Klikkaus päivittää sisältönäkymän -> Perustelu: Selkeä ja intuitiivinen tapa esittää lineaarinen prosessi. Kysymykset (Inform) -> Muotoillut tekstilistat dynaamisessa sisältöalueessa (HTML/CSS) -> Perustelu: Suora ja selkeä tapa esittää agentin esittämät kysymykset. Lopputulos (Inform) -> Esimerkki muotoillusta Markdown-dokumentista (HTML pre-tag) -> Perustelu: Konkretisoi käyttäjälle, millaisen lopputuloksen agentti tuottaa. Uusi datavisualisointiosio on lisätty kvantitatiivista analyysiä varten Chart.js:llä. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #3D352E;
        }
        .nav-item {
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }
        .nav-item.active {
            background-color: #F4EFE7;
            border-left-color: #D4A373;
            color: #3D352E;
            font-weight: 500;
        }
        .nav-item:hover {
            background-color: #F8F5F0;
            border-left-color: #E6CBA8;
        }
        .content-card {
            background-color: #FFFFFF;
            border: 1px solid #F0EAE2;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #F8F5F0;
        }
        ::-webkit-scrollbar-thumb {
            background: #E6CBA8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #D4A373;
        }
        textarea {
            resize: vertical;
        }
        .ai-button {
             background-color: #3D352E;
             color: #FDFBF8;
        }
        .ai-button:hover {
            background-color: #2c2520;
        }
        .ai-button:disabled {
            background-color: #9e968f;
            cursor: not-allowed;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
            max-width: 800px;
            margin: auto;
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-[#3D352E]">Liiketoimintasuunnitelma-Agentti</h1>
            <p class="mt-2 text-lg text-gray-600 max-w-3xl mx-auto">Interaktiivinen työkalu liiketoimintasuunnitelman luontiin ja analysointiin.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <aside class="lg-col-span-1">
                <nav id="navigation" class="sticky top-8 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-semibold mb-4 px-2">Suunnitelman osiot</h2>
                    <ul></ul>
                </nav>
            </aside>

            <div id="main-content-area" class="lg:col-span-3">
                <div id="content"></div>
                <div id="save-area" class="mt-6 text-right flex items-center justify-end"></div>
            </div>
        </main>
        
        <section id="final-output-section" class="mt-12 p-6 md:p-8 rounded-lg content-card">
             <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                <h2 class="text-2xl font-bold">Agentin luoma liiketoimintasuunnitelma</h2>
                <button id="ai-generate-button" class="ai-button font-bold py-2 px-6 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.41 1.583A1 1 0 0010.5 1h-1a1 1 0 00-.91.583L7.175 5H4a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1V6a1 1 0 00-1-1h-3.175l-1.415-3.417zM10 12a3 3 0 100-6 3 3 0 000 6z" /><path d="M12.5 4a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>
                    Luo suunnitelma & Analysoi
                </button>
             </div>
             <p id="output-description" class="mb-6 text-gray-600">Kun olet vastannut kysymyksiin, klikkaa painiketta lähettääksesi tiedot tekoälylle. Se muodostaa niistä kokonaisen liiketoimintasuunnitelman ja luo taloudelliset kaaviot.</p>
             <div class="bg-gray-50 p-6 rounded-md border border-gray-200 text-sm font-mono text-gray-800 overflow-x-auto min-h-[200px] whitespace-pre-wrap">
                 <code id="final-plan-code">Täytä kentät ja paina "Luo suunnitelma & Analysoi" -painiketta.</code>
             </div>
        </section>

        <section id="financial-analysis-section" class="mt-12 p-6 md:p-8 rounded-lg content-card">
             <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                <h2 class="text-2xl font-bold">Taloudellinen Analyysi & Ennusteet</h2>
             </div>
             <p class="mb-8 text-gray-600">Nämä kaaviot perustuvat "Taloussuunnitelma"-osioon syöttämiisi lukuihin ja päivittyvät automaattisesti, kun luot liiketoimintasuunnitelman.</p>
             <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                 <div class="p-4 rounded-lg border">
                     <h3 class="text-lg font-semibold text-center mb-4">Aloituskustannusten erittely</h3>
                     <div class="chart-container h-80"><canvas id="startupCostsChart"></canvas></div>
                 </div>
                 <div class="p-4 rounded-lg border">
                     <h3 class="text-lg font-semibold text-center mb-4">Kuukausittaisten kulujen analyysi</h3>
                     <div class="chart-container h-80"><canvas id="monthlyCostsChart"></canvas></div>
                 </div>
                 <div class="p-4 rounded-lg border xl:col-span-2">
                     <h3 class="text-lg font-semibold text-center mb-4">12 kuukauden tuotto- ja tulosennuste</h3>
                     <div class="chart-container h-96"><canvas id="projectionChart"></canvas></div>
                 </div>
             </div>
        </section>

        <footer class="text-center mt-12 py-6 border-t border-gray-200">
            <p class="text-gray-500">Made by Witas AI Agent.</p>
        </footer>
    </div>

    <script>
        const agentData = [
            {
                id: 'aloitus', title: '1. Aloitus', heading: 'Tervetuloa & Aloitus', description: 'Ensimmäisessä vaiheessa agentti toivottaa käyttäjän tervetulleeksi, selittää prosessin lyhyesti ja kerää perustiedot aloitettavasta liiketoiminnasta. Tämä luo pohjan koko suunnitelmalle.',
                questions: [{ type: 'text', key: 'Liiketoiminnan tyyppi', text: 'Minkä tyyppistä liiketoimintaa suunnittelet aloittavasi?' }, { type: 'text', key: 'Yrityksen nimi', text: 'Mikä on yrityksesi nimi (jos sinulla on jo nimi mielessä)?' }]
            },
            {
                id: 'liikeidea', title: '2. Liikeidea', heading: 'Liikeidea', description: 'Tässä osiossa pureudutaan ytimeen: mitä yritys myy, kenelle ja miksi se on erityinen. Agentti auttaa kirkastamaan liikeidean peruspilarit.',
                questions: [{ type: 'text', key: 'Tuote/palvelu', text: 'Kuvaile yrityksesi tarjoamaa tuotetta tai palvelua lyhyesti.' }, { type: 'text', key: 'Ainutlaatuisuus', text: 'Mikä tekee tuotteestasi tai palvelustasi ainutlaatuisen?' }, { type: 'text', key: 'Kohderyhmä', text: 'Kenelle tuotteesi tai palvelusi on suunnattu (kohderyhmä)?' }]
            },
             {
                id: 'markkina-analyysi', title: '3. Markkina-analyysi', heading: 'Markkina-analyysi', description: 'Yksikään yritys ei toimi tyhjiössä. Tässä vaiheessa agentti ohjaa yrittäjää analysoimaan kilpailukenttää ja tunnistamaan markkinan mahdollisuuksia ja trendejä.',
                questions: [{ type: 'text', key: 'Kilpailijat', text: 'Ketkä ovat tärkeimmät kilpailijasi?' }, { type: 'text', key: 'Erottuvuustekijät', text: 'Miten yrityksesi eroaa kilpailijoista?' }, { type: 'text', key: 'Markkinan mahdollisuudet', text: 'Millaisia trendejä tai mahdollisuuksia markkinoilla on tällä hetkellä?' }]
            },
            {
                id: 'liiketoimintamalli', title: '4. Liiketoimintamalli', heading: 'Liiketoimintamalli', description: 'Miten yritys tekee rahaa ja mitä sen pyörittämiseen vaaditaan? Agentti auttaa määrittelemään ansaintalogiikan, tarvittavat resurssit ja käytännön toimintatavat.',
                questions: [{ type: 'text', key: 'Ansaintalogiikka', text: 'Miten aiot ansaita rahaa (esim. tuotemyynti, palvelumaksu, tilausmalli)?' }, { type: 'text', key: 'Resurssit ja kumppanit', text: 'Millaisia keskeisiä resursseja ja kumppanuuksia tarvitset toiminnan pyörittämiseen?' }, { type: 'text', key: 'Toimitusprosessi', text: 'Miten tuotteen toimitus tai palvelun tuottaminen käytännössä tapahtuu?' }]
            },
            {
                id: 'markkinointi', title: '5. Markkinointi ja myynti', heading: 'Markkinointi ja myynti', description: 'Loistava tuote ei myy itse itseään. Tässä osiossa agentti auttaa suunnittelemaan, miten potentiaaliset asiakkaat tavoitetaan ja miten heidät vakuutetaan.',
                questions: [{ type: 'text', key: 'Asiakashankinta', text: 'Miten aiot tavoittaa ensimmäiset asiakkaasi?' }, { type: 'text', key: 'Markkinointikanavat', text: 'Mitkä markkinointikanavat ovat sinulle tärkeimpiä (esim. sosiaalinen media, verkkosivut, suosittelut)?' }, { type: 'text', key: 'Brändi-ilme', text: 'Millaisen mielikuvan ja viestin haluat brändillesi luoda?' }]
            },
            {
                id: 'taloussuunnitelma',
                title: '6. Taloussuunnitelma',
                heading: 'Taloussuunnitelma',
                description: 'Syötä tähän numeerista dataa analyysiä varten. Lisää ja poista kulueriä tarpeen mukaan.',
                questions: [
                    { type: 'dynamic-list', key: 'Alkupääoma', text: 'Erittele aloituskustannukset' },
                    { type: 'dynamic-list', key: 'Kiinteät kulut', text: 'Erittele kuukausittaiset kiinteät kulut' },
                    { type: 'dynamic-list', key: 'Muuttuvat kulut', text: 'Erittele arvioidut kuukausittaiset muuttuvat kulut' },
                    { type: 'number', key: 'Liikevaihtotavoite', text: 'Mikä on realistinen liikevaihtotavoitteesi ensimmäisen vuoden aikana? (€)' }
                ]
            },
            {
                id: 'riskit', title: '7. Riskit ja varautuminen', heading: 'Riskit ja varautuminen', description: 'Hyvään suunnitteluun kuuluu myös varautuminen vastoinkäymisiin. Viimeisessä vaiheessa agentti auttaa tunnistamaan potentiaalisia riskejä ja miettimään keinoja niiden hallintaan.',
                questions: [{ type: 'text', key: 'Suurimmat riskit', text: 'Mitkä ovat kolme suurinta riskiä liiketoiminnallesi?' }, { type: 'text', key: 'Riskienhallinta', text: 'Miten aiot hallita tai pienentää näitä riskejä?' }]
            }
        ];

        let userAnswers = {};
        let charts = {}; // To hold chart instances

        const navigationEl = document.getElementById('navigation').querySelector('ul');
        const contentEl = document.getElementById('content');
        const mainContentAreaEl = document.getElementById('main-content-area');
        const saveAreaEl = document.getElementById('save-area');
        const finalPlanEl = document.getElementById('final-plan-code');
        const generateButton = document.getElementById('ai-generate-button');
        
        // --- Chart Rendering Functions ---
        function getFinancialDataFromAnswers() {
            const financialAnswers = userAnswers['taloussuunnitelma'] || {};
            const startupDataRaw = financialAnswers[0] || [];
            const fixedDataRaw = financialAnswers[1] || [];
            const variableDataRaw = financialAnswers[2] || [];
            
            const processRawData = (rawData) => {
                const labels = rawData.map(item => item.name || '');
                const values = rawData.map(item => parseFloat(item.value) || 0);
                const total = values.reduce((sum, val) => sum + val, 0);
                return { labels, values, total };
            };

            return {
                startupData: processRawData(startupDataRaw),
                fixedCosts: processRawData(fixedDataRaw),
                variableCosts: processRawData(variableDataRaw),
                yearlyRevenueGoal: parseFloat(financialAnswers[3] || '0')
            };
        }

        function createOrUpdateChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            charts[chartId] = new Chart(ctx, { type, data, options });
        }

        function updateAllCharts() {
            const { startupData, fixedCosts, variableCosts, yearlyRevenueGoal } = getFinancialDataFromAnswers();
            
            createOrUpdateChart('startupCostsChart', 'doughnut', {
                labels: startupData.labels,
                datasets: [{ data: startupData.values, backgroundColor: ['#D4A373', '#F4EFE7', '#3D352E', '#E6CBA8', '#9B7F62'], borderColor: '#FFFFFF', borderWidth: 2 }]
            }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } });

            createOrUpdateChart('monthlyCostsChart', 'bar', {
                labels: ['Kuukausittaiset kulut'],
                datasets: [
                    { label: 'Kiinteät kulut', data: [fixedCosts.total], backgroundColor: '#3D352E' },
                    { label: 'Muuttuvat kulut', data: [variableCosts.total], backgroundColor: '#D4A373' }
                ]
            }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } });

            const monthlyRevenue = yearlyRevenueGoal / 12;
            const totalMonthlyCosts = fixedCosts.total + variableCosts.total;
            const projection = { labels: [], revenues: [], profits: [] };
            for (let i = 1; i <= 12; i++) {
                projection.labels.push(`Kuukausi ${i}`);
                const currentRevenue = (monthlyRevenue / 12) * i * 2;
                projection.revenues.push(currentRevenue);
                projection.profits.push(currentRevenue - totalMonthlyCosts);
            }
            createOrUpdateChart('projectionChart', 'line', {
                labels: projection.labels,
                datasets: [
                    { label: 'Kuukausittainen liikevaihto', data: projection.revenues, borderColor: '#D4A373', tension: 0.1, fill: false },
                    { label: 'Kuukausittainen tulos (Voitto/Tappio)', data: projection.profits, borderColor: '#3D352E', tension: 0.1, fill: false }
                ]
            }, { responsive: true, maintainAspectRatio: false });
        }

        // --- Core Application Logic ---

        function renderContent(sectionId) {
            const sectionData = agentData.find(item => item.id === sectionId);
            if (!sectionData) return;
            if (!userAnswers[sectionId]) userAnswers[sectionId] = {};
            
            const questionsHtml = sectionData.questions.map((q, index) => {
                const savedAnswer = userAnswers[sectionId][index] || (q.type === 'dynamic-list' ? [] : '');
                
                if (q.type === 'dynamic-list') {
                    let itemsHtml = savedAnswer.map((item, itemIndex) => `
                        <div class="flex items-center gap-2 mb-2 dynamic-item-row" data-item-index="${itemIndex}">
                            <input type="text" placeholder="Kuluerän nimi" class="flex-grow p-2 border rounded-md" value="${item.name || ''}" data-type="name">
                            <input type="number" placeholder="Summa (€)" class="w-32 p-2 border rounded-md" value="${item.value || ''}" data-type="value">
                            <button class="remove-item-btn p-2 text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('');
                    
                    return `
                        <div class="mb-6" data-question-index="${index}" data-section-id="${sectionId}">
                            <label class="block font-medium text-gray-800 mb-2">${q.text}</label>
                            <div class="dynamic-list-container space-y-2">${itemsHtml}</div>
                            <button class="add-item-btn mt-2 text-sm text-[#D4A373] hover:text-[#c8935a] font-semibold">+ Lisää kuluerä</button>
                        </div>`;
                } else if (q.type === 'number') {
                     return `<div class="mb-6">
                        <label for="input-${sectionId}-${index}" class="block font-medium text-gray-800 mb-2">${q.text}</label>
                        <input type="number" id="input-${sectionId}-${index}" data-section-id="${sectionId}" data-question-index="${index}" class="mt-1 w-full p-3 rounded-md border" value="${savedAnswer}" placeholder="Esim: 120000">
                    </div>`;
                } else { // type: 'text'
                    return `<div class="mb-6">
                        <label for="textarea-${sectionId}-${index}" class="block font-medium text-gray-800 mb-2">${q.text}</label>
                        <textarea id="textarea-${sectionId}-${index}" data-section-id="${sectionId}" data-question-index="${index}" class="mt-1 w-full p-3 rounded-md border h-28">${savedAnswer}</textarea>
                    </div>`;
                }
            }).join('');

            contentEl.innerHTML = `<div class="p-6 md:p-8 rounded-lg content-card animate-fade-in">
                <h2 class="text-2xl font-bold mb-2">${sectionData.heading}</h2>
                <p class="text-gray-600 mb-8">${sectionData.description}</p>
                <div class="space-y-4">${questionsHtml}</div>
            </div>`;
            
            saveAreaEl.innerHTML = `<span id="save-feedback-${sectionId}" class="mr-4 text-green-600 font-medium opacity-0">Tiedot tallennettu! ✔</span>
                <button id="save-button-${sectionId}" class="bg-[#D4A373] text-white font-bold py-2 px-6 rounded-lg">Tallenna vastaukset</button>`;
        }
        
        async function callAiAgent() {
            const API_KEY = 'AIzaSyAfHoww04oqEKFKL6MZjU5xTn60jMx7tnw';
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            
            generateButton.disabled = true;
            generateButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generoidaan...`;
            finalPlanEl.textContent = 'Lähetetään tietoja tekoälylle...';

            let rawAnswersText = "";
            agentData.forEach(section => {
                rawAnswersText += `\n### ${section.title}\n`;
                section.questions.forEach((question, index) => {
                    const answer = userAnswers[section.id]?.[index];
                    let formattedAnswer = 'Ei vastausta';
                    if (Array.isArray(answer)) {
                        formattedAnswer = answer.map(item => `${item.name || 'Nimetön'}: ${item.value || 0}`).join(', ');
                    } else if (answer) {
                        formattedAnswer = answer;
                    }
                    rawAnswersText += `- **${question.key}:** ${formattedAnswer}\n`;
                });
            });

            const systemPrompt = "You are an expert business consultant. Your task is to create a clear, professional, and well-structured business plan based on the user's provided answers. Formulate the answers into a coherent and flowing text, not just a list of the answers. Use Markdown for formatting. The response must be in Finnish.";
            const userPrompt = `Create a comprehensive business plan from the following raw data:\n\n${rawAnswersText}`;

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                if (!response.ok) throw new Error(`API error: ${response.status} - ${await response.text()}`);
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                finalPlanEl.textContent = generatedText || 'API palautti tyhjän vastauksen.';
                updateAllCharts();
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                finalPlanEl.textContent = `Tapahtui virhe: ${error.message}`;
            } finally {
                 generateButton.disabled = false;
                 generateButton.innerHTML = `<svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.41 1.583A1 1 0 0010.5 1h-1a1 1 0 00-.91.583L7.175 5H4a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1V6a1 1 0 00-1-1h-3.175l-1.415-3.417zM10 12a3 3 0 100-6 3 3 0 000 6z" /><path d="M12.5 4a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>Luo suunnitelma & Analysoi`;
            }
        }

        function init() {
            agentData.forEach((item, index) => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'nav-item block w-full text-left px-4 py-3 rounded-md';
                link.dataset.id = item.id;
                link.textContent = item.title;
                if (index === 0) link.classList.add('active');
                li.appendChild(link);
                navigationEl.appendChild(li);
            });

            navigationEl.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.nav-item');
                if (target?.dataset.id) {
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    target.classList.add('active');
                    renderContent(target.dataset.id);
                }
            });
            
            mainContentAreaEl.addEventListener('input', (e) => {
                const target = e.target;
                const sectionEl = target.closest('[data-section-id]');
                if (!sectionEl) return;
                
                const { sectionId, questionIndex } = target.closest('[data-question-index]').dataset;
                if (!userAnswers[sectionId]) userAnswers[sectionId] = {};
                
                if (target.closest('.dynamic-list-container')) {
                    const listContainer = target.closest('.dynamic-list-container');
                    const items = [];
                    listContainer.querySelectorAll('.dynamic-item-row').forEach(row => {
                        const name = row.querySelector('[data-type="name"]').value;
                        const value = row.querySelector('[data-type="value"]').value;
                        items.push({ name, value });
                    });
                    userAnswers[sectionId][questionIndex] = items;
                } else {
                    userAnswers[sectionId][questionIndex] = target.value;
                }
            });

            mainContentAreaEl.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('.add-item-btn')) {
                    e.preventDefault();
                    const container = target.previousElementSibling;
                    const newRow = document.createElement('div');
                    newRow.className = 'flex items-center gap-2 mb-2 dynamic-item-row';
                    newRow.innerHTML = `
                        <input type="text" placeholder="Kuluerän nimi" class="flex-grow p-2 border rounded-md" data-type="name">
                        <input type="number" placeholder="Summa (€)" class="w-32 p-2 border rounded-md" data-type="value">
                        <button class="remove-item-btn p-2 text-red-500 hover:text-red-700">&times;</button>`;
                    container.appendChild(newRow);
                }
                
                if (target.closest('.remove-item-btn')) {
                    e.preventDefault();
                    const row = target.closest('.dynamic-item-row');
                    const container = row.parentElement;
                    row.remove();
                    // Manually trigger input event on container to re-save data
                    container.dispatchEvent(new Event('input', { bubbles: true }));
                }

                if (target.tagName === 'BUTTON' && target.id.startsWith('save-button-')) {
                    e.preventDefault();
                    const feedbackEl = document.getElementById(target.id.replace('save-button-','save-feedback-'));
                    if (feedbackEl) {
                        feedbackEl.classList.remove('opacity-0');
                        setTimeout(() => feedbackEl.classList.add('opacity-0'), 2500);
                    }
                }
            });
            
            if (generateButton) generateButton.addEventListener('click', callAiAgent);

            renderContent(agentData[0].id);
            updateAllCharts();
            
            const style = document.createElement('style');
            style.innerHTML = `@keyframes animate-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: animate-fade-in 0.5s ease-out forwards; }`;
            document.head.appendChild(style);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

